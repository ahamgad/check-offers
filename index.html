<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/uicons-regular-rounded/css/uicons-regular-rounded.css">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: #FCFCFC;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Inter', sans-serif;
      padding: 16px;
    }
    #cards {
      width: 100%;
      margin: 16px 0;
    }
    .card {
      position: relative;
      background: #fff;
      overflow: hidden;
      border: 1px solid #F2F2F2;
      border-radius: 16px;
      min-height: 240px;
      display: flex;
      flex-direction: column;
      padding: 24px;
      opacity: 0;
      transition: opacity 0.4s ease;
    }
    .card.show { opacity: 1; }
    .card-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      z-index: 2;
    }
    .card-content.final h3:first-child {
      font-size: 14px;
      color: #554D59;
      text-transform: uppercase;
      margin-bottom: 8px;
    }
    .card-content.final h3:nth-child(2) {
      font-size: 24px;
      font-weight: 900;
      text-transform: uppercase;
      color: #AC5FD9;
      margin-bottom: 8px;
    }
    .card-content h3 {
      color: #554D59;
      font-size: 14px;
      font-weight: 900;
      margin-bottom: 8px;
      text-transform: uppercase;
      text-align: center;
    }
    .description {
      margin-top: 4px;
      font-size: 14px;
      color: #554D59;
      text-align: center;
    }
    .status {
      margin-top: 4px;
      font-size: 14px;
      font-weight: 700;
      color: #444;
      text-align: center;
    }
    .terms {
      width: 100%;
      font-size: 14px;
      color: #554D59;
      padding: 16px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: center;
      gap: 8px;
      border: 1px solid #F2F2F2;
      border-radius: 16px;
      background: #FAFAFA;
    }
    .terms-content {
      gap: 8px;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
    }
    .terms-content i {
      color: #8D7F93;
      margin-top: 2px;
    }
    button {
      padding: 8px 16px;
      margin: 16px 0 0;
      background: #FAFAFA;
      color: #AC5FD9;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 800;
      width: auto;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      transition: opacity 0.4s ease;
      z-index: 2;
    }
    button:disabled {
      color: #EFCFFF;
      cursor: not-allowed;
    }
    .progress-bar {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      z-index: 2;
    }
    .progress-segment {
      flex: 1;
      height: 8px;
      background: #FAFAFA;
      border-radius: 4px;
    }
    .progress-segment.filled { background: #B4F7D4; }
    #error-msg {
      text-align: center;
      color: #D12C2C;
      font-size: 14px;
      font-weight: 800;
      display: none;
    }
  </style>
</head>
<body>
  <div style="width: 100%;">
    <div id="error-msg"></div>
    <div id="cards"></div>
    <div class="terms">
      <div class="terms-content"><i class="fi fi-rr-settings"></i>Allow location access when prompted</div>
      <div class="terms-content"><i class="fi fi-rr-home-location-alt"></i>Be inside the Coffee Hut</div>
    </div>
  </div>
  <script>
    const delay = 15;
    const finalDelay = 15;
    const hutLat = 30.054164, hutLng = 31.201395;
    const hutRadius = 0.15;
    let step = +localStorage.stepIndex || 0;
    let start = +localStorage.stepStart || Date.now();
    const save = () => { localStorage.stepIndex = step; localStorage.stepStart = start; };
    const clearAll = () => {
      clearInterval(window.timer);
      clearInterval(window.finalTimer);
    };
    const reset = () => { clearAll(); step = 0; start = Date.now(); save(); render(); };
    const formatTime = (s) => {
      const m = Math.floor(s / 60);
      const ss = s % 60;
      return `00 : ${m.toString().padStart(2,'0')} : ${ss.toString().padStart(2,'0')}`;
    };
    const progressBar = c => {
      const bar = document.createElement('div'); bar.className = 'progress-bar';
      for (let i = 0; i < 3; i++) {
        const seg = document.createElement('div'); seg.className = 'progress-segment' + (i < step ? ' filled' : ''); bar.append(seg);
      }
      c.append(bar);
    };

    function checkProximity(callback) {
      if (!navigator.geolocation) return callback('geo');
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        const dx = latitude - hutLat;
        const dy = longitude - hutLng;
        const dist = Math.sqrt(dx * dx + dy * dy) * 111.32;
        if (dist > hutRadius) return callback('far');
        callback();
      }, err => callback('geo'));
    }

    function render() {
      clearAll();
      const root = document.getElementById('cards'); root.innerHTML = '';
      const err = document.getElementById('error-msg'); err.style.display = 'none'; err.textContent = '';
      if (step > 3) return reset();
      const card = document.createElement('div'); card.className = 'card'; progressBar(card);
      const content = document.createElement('div'); content.className = 'card-content' + (step===3?' final':'');
      if (step===3) {
        const t1 = document.createElement('h3'); t1.textContent = 'Your Offer Is Ready'; content.append(t1);
        const t2 = document.createElement('h3'); t2.textContent = "🎉 LET'S GOOO!"; content.append(t2);
        const d1 = document.createElement('div'); d1.className='description'; d1.textContent='Show this to the cashier before time runs out'; content.append(d1);
        const st = document.createElement('div'); st.className='status'; content.append(st);
        card.append(content); root.append(card); requestAnimationFrame(()=>card.classList.add('show'));
        (function updateFinal() {
          const r = finalDelay - Math.floor((Date.now()-start)/1000);
          if (r>0) st.textContent = formatTime(r); else reset();
        })();
        window.finalTimer = setInterval(() => {
          const r = finalDelay - Math.floor((Date.now()-start)/1000);
          if (r>0) st.textContent = formatTime(r); else reset();
        },1000);
        return;
      }
      const title = document.createElement('h3');
      title.textContent = step === 0 ? "Welcome, Challenger" : step === 1 ? "Almost There" : "Almost Done";
      content.append(title);
      const elapsed = Math.floor((Date.now()-start)/1000);
      const desc = document.createElement('div'); desc.className='description';
      let currentDesc = step===0?'Check-in to unlock level 2 🚀':
        step===1?(elapsed<delay?'Next challenge loading ⏳':'Just one more push to win 🔥'):
        (elapsed<delay?'Next challenge loading ⏳':'Your reward is waiting for you 🏆');
      desc.textContent = currentDesc; content.append(desc);
      let status;
      const btn = document.createElement('button');
      btn.textContent = (step === 0 || step === 1) ? 'Next Mission' : 'Claim Now';
      btn.disabled=(step>0&&elapsed<delay); content.append(btn);

      if (step>0 && elapsed<delay) {
        status = document.createElement('div'); status.className='status'; status.textContent=formatTime(delay-elapsed); content.append(status);
        window.timer = setInterval(()=>{
          const r = delay - Math.floor((Date.now()-start)/1000);
          if (r>0) {
            status.textContent=formatTime(r);
          } else {
            clearInterval(window.timer); status.remove(); btn.disabled=false;
            desc.textContent = step===1 ? 'Just one more push to win 🔥' : 'Your reward is waiting for you 🏆';
          }
        },1000);
      }

      btn.addEventListener('click',()=>{
        const err = document.getElementById('error-msg');
        err.style.display = 'none';
        err.textContent = '';
        checkProximity(error => {
          if (error === 'far') {
            err.textContent = 'You must be at Coffee Hut to proceed';
            err.style.display = 'block';
          } else if (!error) {
            err.style.display = 'none';
            clearAll(); step++; start=Date.now(); save(); render();
          }
        });
      });

      card.append(content); root.append(card); requestAnimationFrame(()=>card.classList.add('show'));
    }
    if (!localStorage.stepStart) save(); render();
  </script>
</body>
</html>
